# 小万专用-磁盘清理 技术方案 (v0.1)

## 1. 目标与范围
- 目标用户: 个人用户
- 平台: Windows 11
- 形式: 图形界面, 中文
- 功能: 磁盘扫描 + 目录/文件占用可视化(卡片钻取)
- 不包含: 清理/删除, 自动化, 导出

## 2. 技术选型(推荐)
- 交付形态: 桌面应用(内置 Web UI, 不依赖外部浏览器)
- 推荐方案: Tauri + Web UI
  - 优点: 体积小、性能好、跨平台可测试
  - 依赖: Windows WebView2(Win11 通常自带, 可做检测与引导安装)
- 备选方案: Electron + Web UI
  - 优点: 自带 Chromium, 对系统依赖更少
  - 缺点: 体积与内存占用较大

> 若坚持纯 Windows 原生 UI, 可选 WPF/WinUI 方案(非当前方案B)

## 3. 模块划分
1) UI 层(Web)
- 盘符选择
- 卡片网格(目录/文件)
- 面包屑导航 + 返回上一级按钮
- 打开所在位置(资源管理器)
- 进度条 + 中断按钮
- 权限/异常提示

2) 桌面壳(Tauri/Electron)
- 内置 WebView 渲染 UI
- 与本地扫描引擎通信(命令/IPC)
- 启动时检测 WebView2(仅 Tauri)

3) 扫描引擎(本地)
- 按需扫描当前目录
- 递归计算目录大小
- 中断与增量回传

4) 状态与数据模型
- 目录/文件节点模型
- 扫描状态管理

## 4. 核心流程
### 4.1 启动
- 显示盘符列表
- 选择盘符后加载根目录一层内容

### 4.2 目录钻取
- 点击目录卡片进入子目录
- 首次进入时触发该目录的递归扫描
- 扫描完成后按大小降序展示

### 4.4 打开所在位置
- 目录卡片: 在资源管理器中打开该目录
- 文件卡片: 在资源管理器中定位该文件(选中高亮)

### 4.3 扫描中断
- 用户可中断扫描
- 中断后保留已扫描数据, 允许继续浏览

## 5. 扫描策略
- 默认按需扫描: 进入某目录时, 扫描该目录的完整子树
- 单次遍历汇总: 对当前目录子树做一次遍历, 在遍历中计算所有子目录累计大小(避免对每个子目录重复扫描)
- 目录大小 = 子文件总和(递归)
- 支持增量更新: 先展示当前层列表, 扫描过程中逐步更新每个条目的大小
- 进度展示: 当前目录进度(以当前层条目完成数/总数为基准), 不按递归文件计数

## 6. 性能与稳定性
- 后台扫描线程, UI 线程只负责渲染
- 批量回传更新, 减少 UI 刷新次数
- 列表虚拟化: 只渲染可视区域卡片, 支持大目录
- 支持取消令牌, 保证中断及时生效
- 缓存已扫描目录的结果, 返回上一级时避免重复扫描
- 扫描仅保留当前层结果, 不保存全量文件元数据, 避免内存膨胀

## 7. 卡片展示
- 目录/文件统一为卡片
- 显示字段:
  - 名称
  - 大小
  - 目录额外显示: 子项数
- 排序: 按大小降序
- 不过滤: 隐藏/系统文件也显示
- 交互: 可打开所在位置(资源管理器)
- 扫描时先展示当前层列表, 逐步更新大小
- 支持搜索: 在当前列表内按名称筛选
- 支持指定路径扫描(目录选择器)

## 8. 权限与异常处理
- 允许以非管理员运行, 但受限目录提示“无权限/未扫描”
- 异常场景:
  - AccessDenied
  - 文件被占用
  - 长路径
  - ReparsePoint(符号链接/挂载点)
- 对 ReparsePoint 做防循环处理

## 9. 数据模型(示例)
- Node
  - Name
  - Path
  - Size
  - IsDirectory
  - ChildCount
  - Status(未扫/扫描中/完成/无权限/失败)

## 10. 测试建议
- 深目录、大文件场景
- 权限目录(如 C:\\Windows)
- 扫描中断后的可用性
- 多盘符切换一致性

## 11. 交付形式
- 桌面应用(内置 Web UI)
- 单个 EXE (双击运行)
- 用户无需额外安装依赖
- 中文单语言
